"use strict";function _readOnlyError(e){throw new Error('"'+e+'" is read-only')}!function(){var s=window.Bliss,e=window.Mavo;e.Backend.register(s.Class({extends:e.Backend,id:"Couchdb",constructor:function(e,t){var n=this;this.statusChangesCallbacks=[],this.id=this.mavo.id||"mavo",this.url=e.split("couchdb=")[1];var r=this.mavo.element.getAttribute("mv-unauthenticated-permissions"),o=this.mavo.element.getAttribute("mv-authenticated-permissions");function i(e){return e?e.split(/\s+/):""===e?[]:void 0}this.ready=s.include(window.PouchDB,"https://cdn.jsdelivr.net/npm/pouchdb@6.4.1/dist/pouchdb.min.js").then(function(){n.remoteDB=new PouchDB(n.url);var e=i(o)||["read","edit","add","delete","save","logout"],t=i(r);if(n.defaultPermissions={authenticated:e,unauthenticated:t},n.permissions.on(n.defaultPermissions.unauthenticated),t){if(!n.remoteDB.login&&t.includes("login"))return s.include(n.remoteDB.login,"https://github.com/pouchdb-community/pouchdb-authentication/releases/download/v1.1.3/pouchdb.authentication.min.js")}else t=n.remoteDB.login?(_readOnlyError("unauthenticatedPermissions"),["read","login"]):(_readOnlyError("unauthenticatedPermissions"),["read"])}).then(function(){n.remoteDB.getSession&&n.remoteDB.getSession().then(function(e){return n.onUser(e.userCtx)});var e=n.mavo.element.getAttribute("mv-server-push");null!==e&&"false"!==e&&n.setListenForChanges(!0)})},onStatusChange:function(e){this.statusChangesCallbacks.push(e)},setListenForChanges:function(n){var r=this;return this.ready.then(function(){if(n){if(!r.syncHandler){var e=function(e){var t,n,r=0;if(0===e.length)return r;for(t=0;t<e.length;t++)n=e.charCodeAt(t),r=(r<<5)-r+n,r|=0;return"couchdb"+r}(r.url),t=new PouchDB(e);r.syncHandler=t.replicate.from(r.remoteDB,{live:!0,retry:!0}).on("change",function(e){if(e&&e.docs&&e.docs.length){var t=e.docs[0];if(1===r.compareDocRevs({_rev:r.rev},t)){r.rev=t._rev;try{r.onNewData(t)}catch(e){console.error("onChange err",e)}}}}).on("paused",function(t){r.statusChangesCallbacks.forEach(function(e){return e(!t)})}).on("error",function(e){r.mavo.error("CouchDB: ".concat(e.error,". ").concat(e.message),e)})}}else r.syncHandler.cancel(),delete r.syncHandler})},onNewData:function(e){return this.mavo.render(e)},load:function(){var t=this;return this.remoteDB.get(this.id).then(function(e){return t.rev=e._rev,e}).catch(function(e){return 404===e.status?{}:Promise.reject(e)})},store:function(e){var t=this;return Promise.resolve().then(function(){if(t.storeData=e,t.mavo.unsavedChanges&&!t.storing)return t.storing=!0,t.put().then(function(){t.storing=!1})})},put:function(t){var n=this;return t=this.storeData||t,delete this.storeData,t._id=this.id,t._rev=this.rev,"_attachments _deleted _revisions _revs_info _conflicts _deleted_conflicts _local_seq".split(" ").forEach(function(e){delete t[e]}),this.remoteDB.put(t).then(function(e){if(n.rev=e.rev,n.storeData)return n.put()}).catch(function(e){return"conflict"===e.name?n.remoteDB.get(n.id).then(function(e){n.rev=e._rev}).then(function(){return n.put(t)}):(n.mavo.error("CouchDB: ".concat(e.error,". ").concat(e.message),e),Promise.reject(e))})},login:function(){var t=this,e=window.prompt("username");if(!e)return Promise.resolve();var n=window.prompt("password");return n?this.remoteDB.login(e,n).then(function(e){return t.onUser(e)}).catch(function(e){return t.mavo.error("CouchDB: "+e.message),Promise.reject(e)}):Promise.resolve()},logout:function(){var e=this;return this.remoteDB.logout().then(function(){e.permissions.off(e.defaultPermissions.authenticated).on(e.defaultPermissions.unauthenticated)})},upload:function(t){var n=this,e="".concat(t.name,"-").concat(Date.now());return this.remoteDB.putAttachment(e,t.name,t,t.type).then(function(e){return"".concat(n.url,"/").concat(e.id,"/").concat(t.name)})},onUser:function(e){return e&&e.name&&this.permissions.off(this.defaultPermissions.unauthenticated).on(this.defaultPermissions.authenticated),Promise.resolve()},compareDocRevs:function(e,t){return e&&e._rev?t&&t._rev?e._rev===t._rev?0:e._rev<t._rev?1:-1:-1:1},static:{test:function(e){return e.startsWith("couchdb=")}}}))}();